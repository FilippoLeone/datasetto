# Low-Latency NGINX RTMP Configuration for Production

worker_processes auto;
worker_rlimit_nofile 8192;
rtmp_auto_push on;
error_log /dev/stderr info;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        max_connections 2048;
        access_log /dev/stdout;
        
        # Low-latency live streaming application
        application live {
            live on;
            play_restart on;
            idle_streams off;
            interleave on;
            sync 100ms;
            
            # Ultra-low latency HLS configuration
            hls on;
            hls_path /tmp/hls;
            hls_fragment 1s;              # 1-second fragments for low latency
            hls_playlist_length 6s;       # Keep only 6 seconds in playlist
            hls_fragment_naming system;
            hls_sync 100ms;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;
            hls_type live;
            
            # Stream optimization
            wait_key on;                  # Wait for keyframe
            wait_video on;                # Wait for video
            drop_idle_publisher 10s;      # Drop inactive publishers
            
            # Buffer optimization
            publish_notify on;
            play_time_fix on;

            # Recording (optional, disable for production if not needed)
            record off;

            # Access control
            allow publish all;
            
            # Authenticate publishers against backend
            on_publish http://backend-server:4000/api/stream/auth?channel=$name&ip=$remote_addr&tcurl=$tcurl&app=$app;
            on_publish_done http://backend-server:4000/api/stream/end?channel=$name&ip=$remote_addr;
            allow play all;
            
            # Optional: Notify on publish/unpublish
            # on_publish http://localhost:3000/api/stream/publish;
            # on_publish_done http://localhost:3000/api/stream/unpublish;
        }
    }
}

# HTTP configuration for HLS with CORS
http {
    include mime.types;
    default_type application/octet-stream;
    access_log /dev/stdout combined;

    # Performance optimization
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip compression for HLS playlists
    gzip on;
    gzip_vary on;
    gzip_types application/vnd.apple.mpegurl application/x-mpegURL text/plain;
    gzip_comp_level 6;

    server {
        listen 80;
        server_name _;

        # HLS stream serving with CORS and caching
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            
            root /tmp;
            
            # CORS headers for all origins (adjust for production)
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'Origin, X-Requested-With, Content-Type, Accept' always;
            add_header Access-Control-Max-Age 1728000;
            
            # Handle preflight requests
            if ($request_method = OPTIONS) {
                return 204;
            }
            
            # Caching headers for low latency
            add_header Cache-Control 'no-cache, no-store, must-revalidate' always;
            add_header Pragma 'no-cache' always;
            add_header Expires '0' always;
            
            # Disable buffering for low latency
            proxy_buffering off;
            
            # Allow directory listing (for debugging, disable in production)
            autoindex on;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
