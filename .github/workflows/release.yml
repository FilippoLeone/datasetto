name: Build and Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build'
        required: true
        type: string

jobs:
  # Build Android APK
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            mobile/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          cd client
          npm ci
          cd ../mobile
          npm ci

      - name: Create environment file
        run: |
          cd client
          cat > .env.mobile << EOF
          VITE_SERVER_URL=https://datasetto.com
          VITE_API_BASE_URL=https://datasetto.com
          VITE_HLS_BASE_URL=https://datasetto.com/hls
          NODE_ENV=production
          EOF

      - name: Build web client
        run: |
          cd mobile
          npm run build:web

      - name: Sync Capacitor
        run: |
          cd mobile
          npx cap sync android

      - name: Build Android APK (unsigned)
        run: |
          cd mobile/android
          chmod +x gradlew
          ./gradlew assembleRelease
          echo "âœ… Built unsigned APK for testing"

      - name: Rename APK
        run: |
          cd mobile/android/app/build/outputs/apk/release
          # Rename the unsigned APK
          if [ -f app-release-unsigned.apk ]; then
            mv app-release-unsigned.apk datasetto-android-${{ github.event.release.tag_name || inputs.tag }}-unsigned.apk
          elif [ -f app-release.apk ]; then
            mv app-release.apk datasetto-android-${{ github.event.release.tag_name || inputs.tag }}-unsigned.apk
          fi
          echo "ðŸ“¦ APK ready: datasetto-android-${{ github.event.release.tag_name || inputs.tag }}-unsigned.apk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: mobile/android/app/build/outputs/apk/release/datasetto-android-*-unsigned.apk

  # Build iOS IPA (requires macOS runner)
  # DISABLED: Requires Apple Developer account and code signing certificates
  # Uncomment this job if you have Apple Developer setup
  build-ios:
    if: false  # Disabled - requires Apple Developer account
    name: Build iOS IPA (Disabled)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            mobile/package-lock.json

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install dependencies
        run: |
          cd client
          npm ci
          cd ../mobile
          npm ci

      - name: Create environment file
        run: |
          cd client
          cat > .env.mobile << EOF
          VITE_SERVER_URL=https://datasetto.com
          VITE_API_BASE_URL=https://datasetto.com
          VITE_HLS_BASE_URL=https://datasetto.com/hls
          NODE_ENV=production
          EOF

      - name: Build web client
        run: |
          cd mobile
          npm run build:web

      - name: Sync Capacitor
        run: |
          cd mobile
          npx cap sync ios

      - name: Install iOS pods
        run: |
          cd mobile/ios/App
          pod install

      - name: Build iOS Archive
        run: |
          cd mobile/ios/App
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $PWD/build/App.xcarchive \
            archive

      - name: Export IPA
        run: |
          cd mobile/ios/App
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string>YOUR_TEAM_ID</string>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath $PWD/build/App.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $PWD/build

      - name: Rename IPA
        run: |
          cd mobile/ios/App/build
          mv App.ipa datasetto-ios-${{ github.event.release.tag_name || inputs.tag }}.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: mobile/ios/App/build/datasetto-ios-*.ipa

  # Build Desktop Apps (Windows, Linux, macOS)
  build-desktop:
    name: Build Desktop - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: mac

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            desktop/package-lock.json

      - name: Install dependencies
        shell: bash
        run: |
          cd client
          npm ci
          cd ../desktop
          npm ci

      - name: Build client for desktop
        shell: bash
        run: |
          cd client
          VITE_BUILD_TARGET=desktop npm run build

      - name: Prepare renderer
        shell: bash
        run: |
          cd desktop
          node ./scripts/copy-dist.mjs

      - name: Generate icon
        shell: bash
        run: |
          cd desktop
          node ./scripts/generate-icon.mjs

      - name: Clean release directory
        shell: bash
        run: |
          cd desktop
          node ./scripts/clean-release.mjs

      - name: Build Electron app
        shell: bash
        run: |
          cd desktop
          npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}
          path: |
            desktop/release/*.exe
            desktop/release/*.dmg
            desktop/release/*.AppImage
            desktop/release/*.deb
          if-no-files-found: error

  # Upload all artifacts to release
  upload-to-release:
    name: Upload to Release
    needs: [build-android, build-desktop]  # iOS removed since it's disabled
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Upload Android APK to release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/android-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # iOS upload removed - build is disabled (requires Apple Developer account)

      - name: Upload Desktop builds to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/desktop-win/*
            artifacts/desktop-linux/*
            artifacts/desktop-mac/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
